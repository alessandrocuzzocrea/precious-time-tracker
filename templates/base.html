<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precious Time Tracker</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Precious Time Tracker</h1>
            <nav style="margin-top: 10px;">
                <a href="/" style="margin-right: 15px;">Tracker</a>
                <a href="/tags">Tags</a>
            </nav>
        </header>
        <main>
            {{template "content" .}}
        </main>
    </div>
    <script>
        function updateActiveDuration() {
            const activeTimer = document.getElementById('active-timer');
            if (!activeTimer) return;

            const startTimeStr = activeTimer.dataset.startTime;
            if (!startTimeStr) return;

            const startTime = new Date(startTimeStr);
            const now = new Date();
            const diffMs = now - startTime;

            const durationDisplay = document.getElementById('active-duration');
            if (!durationDisplay) return;

            if (diffMs < 0) {
                durationDisplay.textContent = "0s";
                return;
            }

            const seconds = Math.floor((diffMs / 1000) % 60);
            const minutes = Math.floor((diffMs / (1000 * 60)) % 60);
            const hours = Math.floor((diffMs / (1000 * 60 * 60)));

            let durFunc = [];
            if (hours > 0) durFunc.push(hours + "h");
            if (minutes > 0) durFunc.push(minutes + "m");
            durFunc.push(seconds + "s");

            durationDisplay.textContent = durFunc.join(" ");
        }

        setInterval(updateActiveDuration, 1000);
        updateActiveDuration(); // Initial call

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('time-input')) {
                const row = e.target.closest('tr');
                const startInput = row.querySelector('.start-time');
                const endInput = row.querySelector('.end-time');
                const durationDisplay = row.querySelector('.live-duration');
                
                if (!startInput || !endInput || !durationDisplay) return;

                const parseDate = (str) => {
                    // Normalize space to T for ISO parsing
                    const isoStr = str.replace(' ', 'T');
                    const d = new Date(isoStr);
                    return isNaN(d.getTime()) ? null : d;
                };

                const start = parseDate(startInput.value);
                const end = parseDate(endInput.value);

                if (start && end) {
                    if (end < start) {
                        durationDisplay.textContent = "Invalid (End < Start)";
                        durationDisplay.style.color = "red";
                    } else {
                        const diffMs = end - start;
                        // Format duration
                        const seconds = Math.floor((diffMs / 1000) % 60);
                        const minutes = Math.floor((diffMs / (1000 * 60)) % 60);
                        const hours = Math.floor((diffMs / (1000 * 60 * 60)));

                        let durFunc = [];
                        if (hours > 0) durFunc.push(hours + "h");
                        if (minutes > 0) durFunc.push(minutes + "m");
                        if (seconds > 0 || durFunc.length === 0) durFunc.push(seconds + "s");

                        durationDisplay.textContent = durFunc.join("");
                        durationDisplay.style.color = ""; // Reset color
                    }
                } else if (start && !endInput.value) {
                     durationDisplay.textContent = "Running";
                     durationDisplay.style.color = "";
                } else {
                    durationDisplay.textContent = "-";
                    durationDisplay.style.color = "";
                }
            }
        });
    </script>
</body>
</html>
