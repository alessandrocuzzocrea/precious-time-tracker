<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precious Time Tracker</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div id="sticky-active-bar" class="sticky-bar" 
         {{if .Active}}data-state="active" data-start-time="{{.Active.StartTime.Format "2006-01-02T15:04:05Z07:00"}}"{{else}}data-state="idle"{{end}}>
        <div class="sticky-bar-content">
            {{if .Active}}
                <div class="tracking-info">
                    <span class="sticky-description">Tracking: <strong>{{.Active.Description}}</strong></span>
                    <span class="sticky-duration-container">Duration: <span id="sticky-duration">0s</span></span>
                </div>
                <form action="/stop" method="POST" style="margin: 0;">
                    <button type="submit" class="btn btn-stop btn-sm">Stop</button>
                </form>
            {{else}}
                <form action="/start" method="POST" class="global-start-form">
                    <input type="text" name="description" placeholder="What are you working on?" required class="sticky-input">
                    <button type="submit" class="btn btn-start btn-sm">Start</button>
                </form>
            {{end}}
        </div>
    </div>
    <div class="container">
        <header>
            <h1>Precious Time Tracker</h1>
            <nav style="margin-top: 10px;">
                <a href="/" style="margin-right: 15px;">Tracker</a>
                <a href="/tags">Tags</a>
            </nav>
        </header>
        <main>
            {{template "content" .}}
        </main>
    </div>
    <script>
        function updateActiveDuration() {
            const stickyBar = document.getElementById('sticky-active-bar');
            if (!stickyBar || stickyBar.dataset.state !== 'active') return;

            const startTimeStr = stickyBar.dataset.startTime;
            if (!startTimeStr) return;

            const startTime = new Date(startTimeStr);
            const now = new Date();
            const diffMs = now - startTime;

            if (diffMs < 0) return;

            const seconds = Math.floor((diffMs / 1000) % 60);
            const minutes = Math.floor((diffMs / (1000 * 60)) % 60);
            const hours = Math.floor((diffMs / (1000 * 60 * 60)));

            let durFunc = [];
            if (hours > 0) durFunc.push(hours + "h");
            if (minutes > 0) durFunc.push(minutes + "m");
            durFunc.push(seconds + "s");

            const formatted = durFunc.join(" ");

            const pageDurationDisplay = document.getElementById('active-duration');
            if (pageDurationDisplay) pageDurationDisplay.textContent = formatted;

            const stickyDurationDisplay = document.getElementById('sticky-duration');
            if (stickyDurationDisplay) stickyDurationDisplay.textContent = formatted;
        }

        setInterval(updateActiveDuration, 1000);
        updateActiveDuration(); // Initial call

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('time-input')) {
                const row = e.target.closest('tr');
                const startInput = row.querySelector('.start-time');
                const endInput = row.querySelector('.end-time');
                const durationDisplay = row.querySelector('.live-duration');
                
                if (!startInput || !endInput || !durationDisplay) return;

                const parseDate = (str) => {
                    // Normalize space to T for ISO parsing
                    const isoStr = str.replace(' ', 'T');
                    const d = new Date(isoStr);
                    return isNaN(d.getTime()) ? null : d;
                };

                const start = parseDate(startInput.value);
                const end = parseDate(endInput.value);

                if (start && end) {
                    if (end < start) {
                        durationDisplay.textContent = "Invalid (End < Start)";
                        durationDisplay.style.color = "red";
                    } else {
                        const diffMs = end - start;
                        // Format duration
                        const seconds = Math.floor((diffMs / 1000) % 60);
                        const minutes = Math.floor((diffMs / (1000 * 60)) % 60);
                        const hours = Math.floor((diffMs / (1000 * 60 * 60)));

                        let durFunc = [];
                        if (hours > 0) durFunc.push(hours + "h");
                        if (minutes > 0) durFunc.push(minutes + "m");
                        if (seconds > 0 || durFunc.length === 0) durFunc.push(seconds + "s");

                        durationDisplay.textContent = durFunc.join("");
                        durationDisplay.style.color = ""; // Reset color
                    }
                } else if (start && !endInput.value) {
                     durationDisplay.textContent = "Running";
                     durationDisplay.style.color = "";
                } else {
                    durationDisplay.textContent = "-";
                    durationDisplay.style.color = "";
                }
            }
        });
    </script>
</body>
</html>
